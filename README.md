# Modern TBank Woocommerce Payments

![T-Bank](tbank/tbank.png)

![PHP 7.4+](https://img.shields.io/badge/PHP-7.4%2B-777bb4)
![WordPress 5.6+](https://img.shields.io/badge/WordPress-5.6%2B-21759b)
![WooCommerce 5.0+](https://img.shields.io/badge/WooCommerce-5.0%2B-96588a)
![License GPLv2+](https://img.shields.io/badge/License-GPLv2%2B-3da639)

Платежный шлюз Т‑Банк для WooCommerce с поддержкой чеков и вебхуков.

## Кому подойдет

- Владельцам магазинов на WooCommerce, которым нужен прием карт через Т‑Банк.
- Разработчикам, которые хотят понятный и расширяемый шлюз без лишнего кода.

## Возможности

- Оплата через форму Т‑Банка.
- Автоматическое подтверждение оплаты по вебхуку.
- Формирование чеков (ФФД 1.05 и 1.2).
- Возвраты с передачей чека возврата.
- Поддержка подписок (WooCommerce Subscriptions).
- Гибкая настройка языка платежной формы.
- Логи для отладки.

## Быстрый старт

1) Установите и активируйте плагин.
2) Перейдите: WooCommerce -> Настройки -> Платежи -> Т‑Банк.
3) Заполните:
   - Терминал
   - Пароль
4) Укажите Webhook URL в личном кабинете Т‑Банка:
   - https://ваш_сайт/wp-content/plugins/modern-tbank-woo-payments/tbank/success.php
5) Сохраните настройки и проведите тестовый платеж.

## Настройка чеков

Чеки формируются на этапе Init и отправляются в Т‑Банк.

1) Включите «Формировать чек».
2) Выберите ФФД и СНО.
3) Укажите Email компании.
4) Выберите признаки предмета и способа расчета.
5) Убедитесь, что в онлайн‑кассе включена именно та СНО, которую вы указали в настройках.

Если в кассе не включена нужная СНО, чек будет отклонен с ошибкой.

## Как работает оплата

1) Клиент оформляет заказ.
2) Плагин отправляет Init в Т‑Банк.
3) Клиент оплачивает на стороне банка.
4) Т‑Банк отправляет вебхук со статусом CONFIRMED.
5) WooCommerce переводит заказ в processing (или completed при авто‑завершении).

## Ключевые функции и зачем они нужны

- Init: создание платежа и передача данных чека.
- Webhook: подтверждение оплаты без участия пользователя.
- GetState: защита от дублей, корректный редирект при повторной попытке оплаты.
- Возврат (Cancel): возврат средств с передачей чека возврата.

## Настройки плагина

- Активность способа оплаты: включает или выключает метод.
- Название и описание: то, что видит покупатель.
- Язык формы: русский или английский.
- Автозавершение заказа: переводит в completed только виртуальные и скачиваемые товары.
- Снижение запасов: сразу или после оплаты.
- Терминал и пароль: данные из личного кабинета Т‑Банка.
- Формирование чека: включает передачу фискальных данных.
- ФФД, СНО, признаки предмета и способа расчета: обязательны для чеков.
- Режим отладки: включает логирование в WooCommerce.

## Где смотреть логи

WooCommerce -> Статус -> Логи -> файл с источником `modern_tbank`.

В логах видны:
- Init запрос и ответ
- Receipt (если включено)
- Webhook payload
- Ошибки валидации

## Требования

- WordPress 5.6+
- WooCommerce 5.0+
- PHP 7.4+
- Доступный вебхук по HTTPS
- Подключенная онлайн‑касса (если нужны чеки)

## Частые ошибки

### Чек отклонен: "Система налогообложения не задана"
В кассе не включена указанная СНО. Включите нужную СНО в кассе или смените СНО в настройках плагина.

### Платеж подтвержден, но заказ не обновился
Проверьте доступность вебхука и валидность секрета. В логах должно быть `Webhook processed: CONFIRMED`.

## Разработчикам

Ключевые файлы:

- `modern-tbank-woo-payments.php` — регистрация шлюза и загрузка.
- `tbank/gateway.php` — основной класс оплаты.
- `tbank/api.php` — запросы к API Т‑Банка.
- `tbank/webhook.php` — обработка вебхуков.
- `tbank/receipt.php` — генерация чека.
